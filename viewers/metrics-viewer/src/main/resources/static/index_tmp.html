<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Metrics Viewer</title>

<!-- jQuery + jQuery UI + Touch Punch -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery-ui-touch-punch@0.2.3/jquery.ui.touch-punch.min.js"></script>

<!-- Plotly -->
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

<link rel="stylesheet" href="metrics-viewer.css" />
<style>
/* --- Run color chip --- */
.run-color {
	display: inline-block;
	width: 10px;
	height: 10px;
	border-radius: 50%;
	margin-right: 6px;
	vertical-align: middle;
}
</style>
</head>

<body>
<div id="layout">
	<!-- Side Panel -->
	<div id="side-panel">
		<div id="side-header">
			<h2>Metrics Viewer</h2>
			<div class="header-buttons">
				<button id="btn-screenshot" title="Screenshot Mode">×</button>
			</div>
		</div>

		<div class="global-controls">
			<button id="btn-reload">Reload</button>
			<button id="btn-auto-reload">Auto Reload: OFF</button>
		</div>

		<div class="section" id="run-section">
			<div class="section-header"><label>Runs</label></div>
			<div class="section-controls">
				<button id="btn-select-all-runs">Select All</button>
				<button id="btn-latest-only">Latest Only</button>
			</div>
			<div id="run-list">
				<label><span class="run-color"></span><input type="checkbox" checked> run_C</label><br>
				<label><span class="run-color"></span><input type="checkbox" checked> run_B</label><br>
				<label><span class="run-color"></span><input type="checkbox"> run_A</label>
			</div>
		</div>

		<div class="section" id="tag-section">
			<div class="section-header"><label>Tags</label></div>
			<div class="section-controls">
				<button id="btn-select-all">Select All</button>
				<button id="btn-clear-all">Clear All</button>
			</div>
			<ul id="tag-list">
				<li id="tag-reward" class="active">reward/mean</li>
				<li id="tag-loss" class="active">loss/q_value</li>
				<li id="tag-epsilon" class="active">epsilon</li>
				<li id="tag-grad">grad_norm</li>
			</ul>
		</div>
	</div>

	<!-- Main Area -->
	<div id="main-area">
		<div id="screenshot-header"></div>
	</div>
</div>

<button id="btn-exit-screenshot">× Exit</button>

<script>
$(function(){
	let autoReload=false;
	let autoReloadTimer=null;

	/* --- Color palette */
	function getPlotlyColors() {
		if (Plotly?.colors?.qualitative?.D3)
			return Plotly.colors.qualitative.D3;
		if (Plotly?.colors?.qualitative?.Plotly)
			return Plotly.colors.qualitative.Plotly;
		// 万一なければフォールバック
		return ["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd",
				"#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf"];
	}
	const colors = getPlotlyColors();

	/* --- Sortable --- */
	$("#tag-list").sortable({
		update:function(){
			const newOrder=$("#tag-list").sortable("toArray").map(id=>id.replace("tag-",""));
			refreshCharts(newOrder);
		}
	});

	/* --- タップ／クリック両対応 --- */
	$("#tag-list li").on("touchstart",function(e){this._touchStart=e.timeStamp;})
	.on("touchend",function(e){
		const time=e.timeStamp-(this._touchStart||0);
		if(time<200)$(this).trigger("click");
	});
	$("#tag-list").on("click","li",function(){
		$(this).toggleClass("active");
		refreshCharts();
	});

	/* --- Run選択 --- */
	$("#btn-select-all-runs").on("click",()=>{$("#run-list input").prop("checked",true);refreshCharts();});
	$("#btn-latest-only").on("click",()=>{
		const $runs=$("#run-list input");
		$runs.prop("checked",false);
		$runs.first().prop("checked",true);
		refreshCharts();
	});
	$("#run-list input").on("change",refreshCharts);

	/* --- Tag操作 --- */
	$("#btn-select-all").on("click",()=>{$("#tag-list li").addClass("active");refreshCharts();});
	$("#btn-clear-all").on("click",()=>{$("#tag-list li").removeClass("active");refreshCharts();});

	/* --- Reload系 --- */
	$("#btn-reload").on("click",refreshCharts);
	$("#btn-auto-reload").on("click",function(){
		autoReload=!autoReload;
		$(this).text(`Auto Reload: ${autoReload?"ON":"OFF"}`);
		if(autoReload){
			autoReloadTimer=setInterval(refreshCharts,5000);
		}else{
			clearInterval(autoReloadTimer);
			autoReloadTimer=null;
		}
	});

	/* --- Screenshot Mode --- */
	$("#btn-screenshot").on("click",()=>{
		$("body").addClass("screenshot-mode");
		$("html, body, #layout, #main-area").css({height:"auto",overflow:"visible"});
		const runs=$("#run-list input:checked").map((i,e)=>$(e).parent().text().trim()).get();
		let titleText="Metrics Viewer";
		if(runs.length===1)titleText+=" — "+runs[0];
		else if(runs.length>1)titleText+=" — Multiple Runs";
		$("#screenshot-header").text(titleText).show();
		$("#btn-exit-screenshot").fadeIn(200);
		setTimeout(()=>{$(".graph-block div[id^='graph-']").each(function(){Plotly.Plots.resize(this);});},300);
	});
	$("#btn-exit-screenshot").on("click",()=>{
		$("body").removeClass("screenshot-mode");
		$("html, body, #layout, #main-area").removeAttr("style");
		$("#screenshot-header, #btn-exit-screenshot").hide();
		setTimeout(()=>{$(".graph-block div[id^='graph-']").each(function(){Plotly.Plots.resize(this);});},300);
	});

	/* --- Graph rendering --- */
	function refreshCharts(tagOrder){
		// assign color chips to run list
		$("#run-list label").each(function(i){
			$(this).find(".run-color").css("background-color", colors[i % colors.length]);
		});

		let order=Array.isArray(tagOrder)?tagOrder:$("#tag-list li").map((i,e)=>$(e).text()).get();
		const activeTags=$("#tag-list li.active").map((i,e)=>$(e).text()).get();
		const drawList=order.filter(t=>activeTags.includes(t));
		const runs=$("#run-list input:checked").map((i,e)=>$(e).parent().text().trim()).get();

		const $area=$("#main-area").empty();
		$area.append('<div id="screenshot-header" style="display:none;"></div>');
		drawList.forEach(tag=>{
			const divId="graph-"+tag.replace(/[^\w-]/g,"_");
			$area.append(`<div class="graph-block"><div class="graph-title">${tag}</div><div id="${divId}"></div></div>`);
			renderPlot(divId,tag,runs);
		});
	}

	function renderPlot(divId,tag,runs){
		let yGen;
		switch(tag){
			case "reward/mean": yGen=step=>100*(1-Math.exp(-step/50))+Math.random()*5; break;
			case "loss/q_value": yGen=step=>100*Math.exp(-step/50)+Math.random()*5; break;
			case "epsilon": yGen=step=>Math.exp(-step/50)+Math.random()*0.05; break;
			default: yGen=step=>Math.random()*10;
		}
		const data=runs.map((r,i)=>({
			x:Array.from({length:100},(_,j)=>j),
			y:Array.from({length:100},(_,j)=>yGen(j)*(1+i*0.1)),
			name:r,
			line:{color:colors[i%colors.length],width:2}
		}));
		Plotly.newPlot(divId,data,{
			margin:{t:10,b:20},height:300,
			plot_bgcolor:"#111",paper_bgcolor:"#111",font:{color:"#ccc"},autosize:true
		},{displayModeBar:false,responsive:true,useResizeHandler:true});
	}

	$(window).on("resize",()=>{$(".graph-block div[id^='graph-']").each(function(){Plotly.Plots.resize(this);});});
	refreshCharts();
});
</script>
</body>
</html>
