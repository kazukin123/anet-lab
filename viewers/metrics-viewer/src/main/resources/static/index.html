<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Metrics Viewer</title>

  <!-- jQuery + select2 + Plotly -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-3.2.0.min.js"></script>

  <style>
    body {
      background: #1e1e1e;
      color: #ccc;
      font-family: sans-serif;
	  margin: 0;
      padding: 5px;
    }
	h2 {
	  margin-top: 0px;
	  margin-bottom: 15px;
	}
    .select2-container--default .select2-selection--multiple {
      background-color: #222;
      border: 1px solid #555;
      color: #ddd;
    }
    .select2-results__option {
      background-color: #333;
      color: #fff;
    }
    .select2-results__option--highlighted {
      background-color: #555 !important;
    }
    #chart {
      margin-top: 30px;
      width: 90%;
      height: 600px;
    }
	/* --- select2 複数選択のバッジ(選択済みタグ)見やすく --- */
	.select2-container--default .select2-selection--multiple .select2-selection__choice {
	  background-color: #444;      /* バッジ背景 */
	  border: 1px solid #666;      /* 枠線 */
	  color: #eee;                 /* 文字色（明るく） */
	}

	.select2-container--default .select2-selection--multiple .select2-selection__choice__remove {
	  color: #bbb;                 /* × ボタンの色 */
	  margin-right: 4px;
	}

	.select2-container--default .select2-selection--multiple .select2-selection__choice__remove:hover {
	  color: #fff;                 /* hoverで明るく */
	}
  </style>
</head>

<body>
  <h2>Metrics Viewer</h2>

  <div>
    <label for="runSelect">Run:</label>
    <select id="runSelect" style="width: 300px;"></select>
  </div>

  <div style="margin-top: 10px;">
    <label for="tagSelect">Tags:</label>
    <!-- multiple 属性を追加 -->
    <select id="tagSelect" multiple="multiple" style="width: 400px;"></select>
  </div>

  <div id="chart"></div>

  <script>
  $(document).ready(function() {
	// 開発用グローバルキャッシュ（本番では削除可）
	window.anetRunCache = {};
	const runCache = window.anetRunCache;

    // --- Run一覧 select2 ---
    $('#runSelect').select2({
      placeholder: 'Select a run',
      ajax: {
        url: '/api/runs',
        dataType: 'json',
        delay: 250,
        processResults: function(data) {
          data.sort((a, b) => (a.runId || a.name || '').localeCompare(b.runId || b.name || ''));
          return {
            results: data.map(r => ({
              id: r.runId || r.name || r.path,
              text: r.runId || r.name || r.path
            }))
          };
        }
      },
      allowClear: true,
      width: 'resolve'
    });

    // --- Tag一覧 select2（複数選択可） ---
    $('#tagSelect').select2({
      placeholder: 'Select one or more tags',
      allowClear: true,
      width: 'resolve'
    });

    // --- Run選択時 ---
    $('#runSelect').on('change', function() {
      const runId = $(this).val();
      if (!runId) return;

      if (runCache[runId]) {
        console.log(`Cache hit for ${runId}`);
        renderAllCharts(runId);
        loadTagSelect(runId);
      } else {
        console.log(`Fetching full metrics for ${runId}...`);
        $('#chart').text('Loading metrics data...');
        $.getJSON(`/api/metrics/${runId}`, function(data) {
          runCache[runId] = data;
          renderAllCharts(runId);
          loadTagSelect(runId);
        });
      }
    });

    // --- 複数タグ選択時に複数グラフ描画 ---
    $('#tagSelect').on('change', function() {
      const runId = $('#runSelect').val();
      const tags = $(this).val();
      if (!runId || !tags || tags.length === 0) {
        // 全タグ選択解除時：全体グラフに戻す
        if (runId) renderAllCharts(runId);
        return;
      }
      renderMultiChart(runId, tags);
    });

    // --- タグリスト読込 ---
    function loadTagSelect(runId) {
      const all = runCache[runId];
      const tags = all.map(s => s.tag);
	  tags.sort((a, b) => a.localeCompare(b));
      const $tagSelect = $('#tagSelect');
      $tagSelect.empty();
      tags.forEach(tag => $tagSelect.append(new Option(tag, tag)));
      $tagSelect.trigger('change.select2');
      console.log(`Loaded ${tags.length} tags`);
    }

	function toTrace(s) {
	  if (!s.points || s.points.length < 2) return null;

	  // step 昇順にソート
	  const sorted = [...s.points].sort((a, b) => a.step - b.step);

	  return {
	    x: sorted.map(p => p.step),
	    y: sorted.map(p => Number.isFinite(p.value) ? p.value : NaN),
	    type: 'scatter',
	    mode: 'lines',
	    name: s.tag,
	    connectgaps: false
	  };
	}
	
    // --- 全タグ一括描画 ---
	function renderAllCharts(runId) {
	  $('#chart').empty();
	  const all = anetRunCache[runId];
	  const traces = all
	    .map(toTrace)
	    .filter(t => t !== null);

	  const layout = {
	    paper_bgcolor: '#1e1e1e',
	    plot_bgcolor: '#1e1e1e',
	    font: { color: '#ddd' },
	    title: `${runId} — all tags (${traces.length})`
	  };
	  Plotly.newPlot('chart', traces, layout, { responsive: true });
	}

    // --- 選択された複数タグのグラフ描画 ---
	function renderMultiChart(runId, tags) {
	  $('#chart').empty();
	  const all = anetRunCache[runId];
	  const traces = all
	    .filter(s => tags.includes(s.tag))
	    .map(toTrace)
	    .filter(t => t !== null);

	  const layout = {
	    paper_bgcolor: '#1e1e1e',
	    plot_bgcolor: '#1e1e1e',
	    font: { color: '#ddd' },
	    title: `${runId} — selected tags (${tags.length})`
	  };
	  Plotly.newPlot('chart', traces, layout, { responsive: true });
	}

	setInterval(() => {
	  const runId = $('#runSelect').val();
	  if (runId) {
	    console.log('Auto-refresh metrics...');
	    $.getJSON(`/api/metrics/${runId}`, data => {
	      anetRunCache[runId] = data;
	      const selectedTags = $('#tagSelect').val();
	      if (selectedTags && selectedTags.length > 0) {
	        renderMultiChart(runId, selectedTags);
	      } else {
	        renderAllCharts(runId);
	      }
	    });
	  }
	}, 10000); // 10秒ごと
  });
  </script>
</body>
</html>
