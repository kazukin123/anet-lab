<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>Metrics Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; margin: 16px; }
    #controls { display: flex; gap: 8px; align-items: center; margin-bottom: 12px; }
    select, button { padding: 6px 8px; }
    #chart { width: 100%; height: 72vh; }
  </style>
</head>
<body>
  <h1>Metrics Viewer</h1>
  <div id="controls">
    <label for="run">Run:</label>
    <select id="run"></select>
    <label for="tag">Tag:</label>
    <input id="tag" type="text" placeholder="e.g. eval_reward" size="24">
    <button id="reload">Reload</button>
  </div>
  <div id="chart"></div>

  <script>
    const runSel = document.getElementById('run');
    const tagInput = document.getElementById('tag');
    const reloadBtn = document.getElementById('reload');
    const chartDiv = document.getElementById('chart');

    async function fetchRuns() {
      const res = await fetch('/api/runs');
      return res.json();
    }

    async function fetchSeries(runId, tag) {
      const u = tag ? `/api/metrics/${encodeURIComponent(runId)}?tag=${encodeURIComponent(tag)}` :
        `/api/metrics/${encodeURIComponent(runId)}`;
      const res = await fetch(u);
      return res.json();
    }

    function fillRuns(runs) {
      runSel.innerHTML = '';
      runs.forEach(r => {
        const opt = document.createElement('option');
        opt.value = r.runId;
        opt.textContent = r.name || r.runId;
        runSel.appendChild(opt);
      });
    }

    function chooseDefaultTag(series) {
      if (!series || series.length === 0) return '';
      return series[0].tag || '';
    }

    function draw(series) {
      if (!series || series.length === 0) {
        Plotly.react(chartDiv, [], {title: 'No data'});
        return;
      }
      const s = series[0];
      const xs = s.points.map(p => p.step);
      const ys = s.points.map(p => p.value);
      const trace = { x: xs, y: ys, mode: 'lines', name: s.tag };
      Plotly.react(chartDiv, [trace], { title: s.tag, margin: { t: 40 } });
    }

    async function init() {
      const runs = await fetchRuns();
      if (!runs || runs.length === 0) {
        draw([]);
        return;
      }
      fillRuns(runs);
      const runId = runSel.value;
      let data = await fetchSeries(runId, tagInput.value.trim());
      if (!tagInput.value) {
        tagInput.value = chooseDefaultTag(data.series);
      }
      draw(data.series);
    }

    reloadBtn.addEventListener('click', async () => {
      const runId = runSel.value;
      const tag = tagInput.value.trim();
      const data = await fetchSeries(runId, tag);
      draw(data.series);
    });

    // Simple polling for updates.
    setInterval(async () => {
      const runId = runSel.value;
      if (!runId) return;
      const tag = tagInput.value.trim();
      const data = await fetchSeries(runId, tag);
      draw(data.series);
    }, 5000);

    init();
  </script>
</body>
</html>
